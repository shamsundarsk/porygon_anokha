// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  phone             String    @unique
  password          String
  name              String
  userType          String    // CUSTOMER, ENTERPRISE, DRIVER, ADMIN
  businessType      String    @default("B2C") // B2C, B2B
  companyName       String?
  
  // Driver specific fields
  vehicleType       String?   // BIKE, AUTO, MINI_TRUCK, PICKUP
  vehicleNumber     String?
  licenseNumber     String?
  
  // Security fields
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  emailVerified     Boolean   @default(false)
  phoneVerified     Boolean   @default(false)
  tokenVersion      Int       @default(0) // For forced logout
  lastLogin         DateTime?
  loginAttempts     Int       @default(0)
  lockedUntil       DateTime?
  passwordChangedAt DateTime  @default(now())
  
  // Encrypted sensitive data
  encryptedPhone    String? // Encrypted phone for PII protection
  encryptedLicense  String? // Encrypted license number
  
  // Location and status
  currentLat        Float?
  currentLng        Float?
  isOnline          Boolean   @default(false)
  lastSeen          DateTime  @default(now())
  
  // Ratings and performance
  rating            Float     @default(0)
  totalRatings      Int       @default(0)
  completedDeliveries Int     @default(0)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  customerDeliveries Delivery[] @relation("CustomerDeliveries")
  driverDeliveries   Delivery[] @relation("DriverDeliveries")
  earnings           Earning[]
  reviews            Review[]   @relation("UserReviews")
  givenReviews       Review[]   @relation("ReviewsByUser")
  notifications      Notification[]
  auditLogs          AuditLog[]
  securityEvents     SecurityEvent[]
  refreshTokens      RefreshToken[]
  
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  deviceId    String? // For device binding
  userAgent   String?
  ipAddress   String?
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
}

model Delivery {
  id                    String         @id @default(cuid())
  orderId               String         @unique // Server-generated order ID
  
  // Customer and driver
  customerId            String
  driverId              String?
  
  // Addresses
  pickupAddress         String
  pickupLat             Float
  pickupLng             Float
  deliveryAddress       String
  deliveryLat           Float
  deliveryLng           Float
  
  // Package details
  packageType           String         // DOCUMENT, PARCEL, FOOD, etc.
  packageWeight         Float
  packageValue          Float
  packageDescription    String
  isFragile             Boolean        @default(false)
  
  // Pricing (immutable after creation)
  baseFare              Float
  distanceCost          Float
  fuelAdjustment        Float
  tollCharges           Float          @default(0)
  waitingCharges        Float          @default(0)
  platformCommission    Float
  totalFare             Float
  driverEarnings        Float
  
  // Status and tracking
  status                String         @default("PENDING") // PENDING, ACCEPTED, etc.
  scheduledTime         DateTime?
  acceptedAt            DateTime?
  pickedUpAt            DateTime?
  deliveredAt           DateTime?
  cancelledAt           DateTime?
  
  // Distance and time
  estimatedDistance     Float
  estimatedDuration     Int
  actualDistance        Float?
  actualDuration        Int?
  
  // Security and validation
  fareHash              String? // Hash of fare components for tamper detection
  statusHash            String? // Hash of status changes
  idempotencyKey        String? @unique // For preventing duplicate operations
  
  // Additional info
  customerNotes         String?
  driverNotes           String?
  businessType          String         @default("B2C")
  
  // Timestamps
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  
  // Relations
  customer              User           @relation("CustomerDeliveries", fields: [customerId], references: [id])
  driver                User?          @relation("DriverDeliveries", fields: [driverId], references: [id])
  trackingUpdates       TrackingUpdate[]
  reviews               Review[]
  disputes              Dispute[]
  payments              Payment[]
  auditLogs             AuditLog[]
  
  @@map("deliveries")
}

model TrackingUpdate {
  id          String   @id @default(cuid())
  deliveryId  String
  status      String   // PENDING, ACCEPTED, etc.
  location    String?
  lat         Float?
  lng         Float?
  notes       String?
  timestamp   DateTime @default(now())
  
  // Security
  ipAddress   String?
  userAgent   String?
  
  delivery    Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  
  @@map("tracking_updates")
}

model Payment {
  id                String   @id @default(cuid())
  deliveryId        String
  amount            Float
  currency          String   @default("INR")
  status            String   // pending, completed, failed, refunded
  paymentMethod     String?
  transactionId     String?  @unique
  gatewayResponse   String?  // JSON as string
  
  // Security
  idempotencyKey    String   @unique
  webhookVerified   Boolean  @default(false)
  amountHash        String? // Hash for tamper detection
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  delivery          Delivery @relation(fields: [deliveryId], references: [id])
  
  @@map("payments")
}

model Earning {
  id              String   @id @default(cuid())
  driverId        String
  deliveryId      String?
  amount          Float
  type            String   // delivery, bonus, penalty
  description     String?
  
  // Audit trail
  calculatedAt    DateTime @default(now())
  paidAt          DateTime?
  
  driver          User     @relation(fields: [driverId], references: [id])
  
  @@map("earnings")
}

model Review {
  id          String   @id @default(cuid())
  deliveryId  String
  reviewerId  String
  revieweeId  String
  rating      Int      // 1-5
  comment     String?
  
  // Security
  isVerified  Boolean  @default(false)
  ipAddress   String?
  
  createdAt   DateTime @default(now())
  
  delivery    Delivery @relation(fields: [deliveryId], references: [id])
  reviewer    User     @relation("ReviewsByUser", fields: [reviewerId], references: [id])
  reviewee    User     @relation("UserReviews", fields: [revieweeId], references: [id])
  
  @@unique([deliveryId, reviewerId])
  @@map("reviews")
}

model Dispute {
  id          String   @id @default(cuid())
  deliveryId  String
  raisedBy    String
  reason      String
  description String
  status      String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  resolution  String?
  
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  
  delivery    Delivery @relation(fields: [deliveryId], references: [id])
  
  @@map("disputes")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // info, warning, success, error
  isRead    Boolean  @default(false)
  data      String?  // JSON as string
  
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

model PricingRule {
  id              String   @id @default(cuid())
  name            String
  vehicleType     String?  // BIKE, AUTO, etc.
  businessType    String?  // B2C, B2B
  baseFare        Float
  perKmRate       Float
  perMinuteRate   Float
  minimumFare     Float
  maximumFare     Float?
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("pricing_rules")
}

// Security and Audit Models

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?
  deliveryId  String?
  action      String      // CREATE, UPDATE, DELETE, etc.
  resource    String      // table name or resource type
  resourceId  String?     // ID of the affected resource
  oldValues   String?     // JSON as string
  newValues   String?     // JSON as string
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime    @default(now())
  
  user        User?       @relation(fields: [userId], references: [id])
  delivery    Delivery?   @relation(fields: [deliveryId], references: [id])
  
  @@map("audit_logs")
}

model SecurityEvent {
  id          String            @id @default(cuid())
  userId      String?
  eventType   String            // FAILED_LOGIN, SUSPICIOUS_ACTIVITY, etc.
  severity    String            @default("medium") // low, medium, high, critical
  description String
  ipAddress   String?
  userAgent   String?
  metadata    String?           // JSON as string
  resolved    Boolean           @default(false)
  
  timestamp   DateTime          @default(now())
  
  user        User?             @relation(fields: [userId], references: [id])
  
  @@map("security_events")
}

model HoneypotLog {
  id          String   @id @default(cuid())
  endpoint    String
  method      String
  ipAddress   String
  userAgent   String?
  headers     String?  // JSON as string
  body        String?  // JSON as string
  timestamp   DateTime @default(now())
  
  @@map("honeypot_logs")
}

model CanaryRecord {
  id          String   @id @default(cuid())
  type        String   // user, delivery, payment
  identifier  String   @unique
  accessed    Boolean  @default(false)
  accessedAt  DateTime?
  accessedBy  String?
  ipAddress   String?
  
  createdAt   DateTime @default(now())
  
  @@map("canary_records")
}